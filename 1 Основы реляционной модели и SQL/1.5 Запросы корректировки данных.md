# Запросы корректировки данных

SQL позволяет не только выбирать данные из таблиц базы данных, но и корректировать информацию в них. Для этого  
используются запросы корректировки данных, с помощью которых можно:

- создать пустую таблицу;
- добавить в таблицу записи как совокупность значений;
- добавить записи из другой таблицы;
- добавить записи из другой таблицы, используя вложенный запрос;
- изменить значения в одном столбце;
- изменить значения в нескольких столбцах;
- изменить данные, используя несколько таблиц;
- удалить записи из таблицы;
- создать таблицу на основе данных других таблиц.

## Создание пустой таблицы (CREATE)

Создание таблицы осуществляется с помощью запроса `CREATE`.

Запрос:
```sql
CREATE TABLE supply(
    supply_id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(50),
    author VARCHAR(30),
    price DECIMAL(8,2),
    amount INT
);
```

Пояснение:  
_Создать таблицу поставка **supply**:_
- _supply_id - INT PRIMARY KEY AUTO_INCREMENT;_
- _title - VARCHAR(50);_
- _author - VARCHAR(30);_
- _price	- DECIMAL(8, 2);_
- _amount - INT._
___

## Добавление записей в таблицу (INSERT | VALUES)

Добавление одной записи в таблицу осуществляется с помощью запроса `INSERT`.

Запрос:
```sql
INSERT INTO supply(title, author, price, amount)
VALUES
    ('Лирика', 'Пастернак Б.Л.', 518.99, 2),
    ('Черный человек', 'Есенин С.А.', 570.20, 6),
    ('Белая гвардия', 'Булгаков М.А.', 540.50, 7),
    ('Идиот', 'Достоевский Ф.М.', 360.80, 3);
SELECT * FROM supply;
```

Пояснение:  
_Занесение в таблицу supply четырех записей._

Вывод:
```commandline
Affected rows: 4

Query result:
+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+
Affected rows: 4
```
___

## Добавление записей из другой таблицы

С помощью запроса на добавление можно не только добавить в таблицу конкретные значения (список `VALUES`), но и записи  
из другой таблицы, отобранные с помощью запроса на выборку.  В этом случае вместо раздела `VALUES` записывается запрос  
на выборку, начинающийся с `SELECT`.  В нем можно использовать `WHERE`, `GROUP BY`, `ORDER BY`.

Правила соответствия между полями таблицы и вставляемыми значениями из запроса:

1. Количество полей в таблице и количество полей в запросе должны совпадать;
2. Должно существовать прямое соответствие между позицией одного и того же элемента в обоих списках, поэтому первый  
столбец запроса должен относиться к первому столбцу в списке столбцов таблицы, второй – ко второму столбцу и т.д.
3. Типы столбцов запроса должны быть совместимы с типами данных соответствующих столбцов таблицы (целое число можно  
занести в поле типа `DECIMAL`, обратная операция – недопустима).

Запрос:
```sql
INSERT INTO book(title, author, price, amount)
SELECT title, author, price, amount
FROM supply
WHERE author NOT IN ('Булгаков М.А.', 'Достоевский Ф.М.');
```

Пояснение:  
_Добавить из таблицы supply в таблицу book, все книги, кроме книг, написанных Булгаковым М.А. и Достоевским Ф.М._
___

## Добавление записей, вложенные запросы

В запросах на добавление можно использовать вложенные запросы.

Запрос:
```sql
INSERT INTO book(title, author, price, amount)
SELECT title, author, price, amount
FROM supply
WHERE author NOT IN(
    SELECT author
    FROM book);
```

Пояснение: 
_Занести из таблицы supply в таблицу book только те книги, авторов которых нет в book._
___

## Запросы на обновление (UPDATE)

Под обновлением данных подразумевается изменение значений в существующих записях таблицы. При этом возможно как  
изменение значений полей в группе строк (даже всех строк таблицы), так и правка значения поля отдельной строки.

Изменение записей в таблице реализуется с помощью запроса `UPDATE`. Простейший запрос на обновление выглядит так:

`UPDATE таблица SET поле = выражение`

где:  
- **таблица** – имя таблицы, в которой будут проводиться изменения;  
- **поле** – поле таблицы, в которое будет внесено изменение;
- **выражение** – выражение, значение которого будет занесено в поле.

Запрос:
```sql
UPDATE book
SET price = 0.9 * price
WHERE amount BETWEEN 5 AND 10;
```

Пояснение:  
_Уменьшить на 10% цену тех книг в таблице book, количество которых принадлежит интервалу от 5 до 10, включая границы._  
___

## Запросы на обновление нескольких столбцов 

Запросом `UPDATE` можно обновлять значения нескольких столбцов одновременно:

`UPDATE таблица SET поле1 = выражение1, поле2 = выражение2`

Запрос:
```sql
UPDATE book 
SET buy = IF (buy >= amount, amount, buy ),
price = IF(buy = 0, price * 0.9, price);
SELECT * FROM book;
```

Пояснение:  
В таблице **book** необходимо скорректировать значение для покупателя в столбце **buy** таким образом, чтобы оно не  
превышало количество экземпляров книг, указанных в столбце **amount**. А цену тех книг, которые покупатель не заказывал,  
снизить на 10%.
___

## Запросы на обновление нескольких таблиц 

В запросах на обновление можно использовать несколько таблиц:

- для столбцов, имеющих одинаковые имена, необходимо указывать имя таблицы, к которой они относятся, например,  
`book.price` – столбец `price` из таблицы `book`, `supply.price` – столбец `price` из таблицы `supply`;  
- все таблицы, используемые в запросе, нужно перечислить после ключевого слова `UPDATE`;
- в запросе обязательно условие `WHERE`, в котором указывается условие, при котором обновляются данные.

Запрос:
```sql
UPDATE book, supply
SET book.amount = book.amount + supply.amount,
book.price = ((book.price + supply.price)/2)
WHERE book.title = supply.title and book.author = supply.author;

SELECT * FROM book;
```

Пояснение:  
_Для тех книг в таблице book, которые есть в таблице supply, не только увеличить их количество в таблице book  
(увеличить их количество на значение столбца amount таблицы supply), но и пересчитать их цену (для каждой книги  
найти сумму цен из таблиц book и supply и разделить на 2)._

Вывод:
```commandline
Affected rows: 2

Query result:
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 12     |
| 3       | Идиот                 | Достоевский Ф.М. | 410.40 | 13     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
Affected rows: 5
```
___

## Запросы на удаление

Запросы корректировки данных позволяют удалить одну или несколько записей из  таблицы. Простейший запрос на удаление  
имеет вид:

`DELETE FROM таблица;`

Этот запрос удаляет все записи из указанной после `FROM` таблицы.

Запрос:
```sql
DELETE FROM supply
WHERE author IN( 
    SELECT author
    FROM book
    GROUP BY author
    HAVING SUM(amount)>=10
    );
```

Пояснение:  
_Удалить из таблицы supply книги тех авторов, общее количество экземпляров книг которых в таблице book превышает 10._
___

## Запросы на создание таблицы

Новая таблица может быть создана на основе данных из другой таблицы. Для этого используется запрос `SELECT`,  
результирующая таблица которого и будет новой таблицей базы данных. При этом имена столбцов запроса становятся  
именами столбцов новой таблицы. Запрос на создание новой таблицы имеет вид:

```sql
CREATE TABLE имя_таблицы AS
SELECT ...
```

Запрос:
```sql
CREATE TABLE ordering AS
SELECT author, title,
    (
     SELECT ROUND(AVG(amount))
     FROM book
    ) AS amount
FROM book
WHERE amount < 
    (
     SELECT AVG(amount)
     FROM book
    );
```

Пояснение:  
_Создать таблицу заказ (ordering), куда включить авторов и названия тех книг, количество экземпляров которых в таблице  
book меньше среднего количества экземпляров книг в таблице book. В таблицу включить столбец amount, в котором для  
всех книг указать одинаковое значение - среднее количество экземпляров книг в таблице book._
___

### P.S.

Запрос на добавление нескольких записей в таблицу:
```sql
INSERT INTO book (title, author_id, genre_id, price, amount) VALUES
(
    'Стихотворения и поэмы',
    (SELECT author_id FROM author WHERE name_author = 'Есенин С.А.'),
    (SELECT genre_id FROM genre WHERE name_genre = 'Поэзия'),
    650.00, 15
),
(
    'Черный человек',
    (SELECT author_id FROM author WHERE name_author = 'Есенин С.А.'),
    (SELECT genre_id FROM genre WHERE name_genre = 'Поэзия'),
    570.20, 6
),
(
    'Лирика',
    (SELECT author_id FROM author WHERE name_author = 'Пастернак Б.Л.'),
    (SELECT genre_id FROM genre WHERE name_genre = 'Поэзия'),
    518.99, 2
);

```